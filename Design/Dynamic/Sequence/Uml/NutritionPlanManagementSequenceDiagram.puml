@startuml NutritionPlanManagementSequenceDiagram
!theme vibrant
title Biểu đồ Tuần tự cho Chức năng Tạo Kế hoạch Dinh dưỡng

actor NgườiDùng as User
participant "WebApp (Giao diện)" as WebApp
participant "NutritionPlanController" as Controller
participant "NutritionPlanService" as Service
participant "AIEngine" as AIEngine
participant "Database" as DB

User -> WebApp: Chọn "Tạo kế hoạch mới"
activate WebApp
WebApp -> Controller: GET /plans/create-form
activate Controller
Controller --> WebApp: Hiển thị form tạo kế hoạch
deactivate Controller

User -> WebApp: Điền thông tin và nhấn "Lưu"
WebApp -> Controller: POST /plans/create (planData)
activate Controller
Controller -> Service: createAndAnalyzePlan(planData)
activate Service

Service -> AIEngine: calculateNutrition(meals)
activate AIEngine
AIEngine --> Service: nutritionResult
deactivate AIEngine

Service -> Service: compareWithTarget(nutritionResult, target)

alt Kế hoạch hợp lệ
    Service -> DB: savePlan(newPlan)
    activate DB
    DB --> Service: savedPlan
    deactivate DB

    Service -> DB: generateAndSaveShoppingList(savedPlan)
    activate DB
    DB --> Service: shoppingList
    deactivate DB

    Service --> Controller: planDetails
    Controller --> WebApp: 201 Created (planDetails)
    WebApp --> User: Hiển thị chi tiết kế hoạch thành công

else Kế hoạch không hợp lệ (chênh lệch lớn)
    Service --> Controller: ErrorResponse("Cảnh báo dinh dưỡng")
    Controller --> WebApp: 400 Bad Request (ErrorResponse)
    WebApp --> User: Hiển thị thông báo lỗi trên form
end

deactivate Service
deactivate Controller
deactivate WebApp

@enduml
