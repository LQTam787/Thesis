@startuml AuthenticationSequence
' Authentication Sequence Diagram

title Biểu đồ Tuần tự cho Chức năng Đăng ký và Đăng nhập

actor "Người dùng" as User
participant "AuthController" as Controller
participant "AuthService" as Service
participant "UserRepository" as Repository
participant "PasswordEncoder" as Encoder
participant "AuthenticationManager" as AuthManager

== Kịch bản Đăng ký ==

User -> Controller: POST /register (dto)
activate Controller

Controller -> Service: register(dto)
activate Service

Service -> Repository: findByEmail(dto.email)
activate Repository
Repository --> Service: Optional.empty()
deactivate Repository

Service -> Encoder: encode(dto.password)
activate Encoder
Encoder --> Service: hashedPassword
deactivate Encoder

Service -> Service: createUserFromDto(dto)

Service -> Repository: save(user)
activate Repository
Repository --> Service: savedUser
deactivate Repository

Service --> Controller: void
deactivate Service

Controller --> User: redirect:/login?success
deactivate Controller

== Kịch bản Đăng nhập ==

User -> Controller: POST /login (dto)
activate Controller

Controller -> Service: login(dto)
activate Service

Service -> AuthManager: authenticate(token)
activate AuthManager

' UserDetailsService (do Spring Security gọi ngầm)
AuthManager -> Service: loadUserByUsername(email)
activate Service
Service -> Repository: findByEmail(email)
activate Repository
Repository --> Service: userDetails
deactivate Repository
Service --> AuthManager: userDetails
deactivate Service

' PasswordEncoder (do Spring Security gọi ngầm)
AuthManager -> Encoder: matches(rawPass, encodedPass)
activate Encoder
Encoder --> AuthManager: true
deactivate Encoder

AuthManager --> Service: Authentication
deactivate AuthManager

Service -> Service: setAuthenticationContext()

Service --> Controller: void
deactivate Service

Controller --> User: redirect:/dashboard
deactivate Controller

@enduml
